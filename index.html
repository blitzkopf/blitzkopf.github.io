<html>

<head>
<title>Bunga Bunga</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54107862-1', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>
<script type="text/javascript" src="jquery-2.1.1.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 vColor;
	varying vec3 vLightWeighting;
    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;

	//uniform vec4 vColor2;

    void main(void) {
		vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t))*vColor;
		gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);
        //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
		//gl_FragColor = vec4(vColor.rgb*vLightWeighting,vColor.a);
        //gl_FragColor = vColor;
		//gl_FragColor = vec4(0.1, 1.0, 0.0, 1.0);
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
	attribute vec3 aVertexNormal;
    attribute vec4 aVertexColor;
    attribute vec2 aTextureCoord;

	uniform vec4 uVertexColor;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat3 uNMatrix;

	uniform vec3 uAmbientColor;

	uniform vec3 uLightingDirection;
	uniform vec3 uDirectionalColor;

	uniform bool uUseLighting;

    varying vec4 vColor;
	varying vec2 vTextureCoord;
	varying vec3 vLightWeighting;

    void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
		//vColor = aVertexColor;
		vTextureCoord = aTextureCoord;
		vColor = vec4(uVertexColor[0],uVertexColor[1],uVertexColor[2],uVertexColor[3]);
		//vColor = vec4(0.1, 1.0, 0.0, 1.0);
		if (!uUseLighting) {
		  vLightWeighting = vec3(1.0, 1.0, 1.0);
		} else {
		  //vec3 transformedNormal = uNMatrix * aVertexPosition;
		  vec3 transformedNormal = uNMatrix * aVertexNormal;
		  float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);
		  vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
		}

    }
</script>
<script type="text/javascript" src="webgl-setup.js" ></script>
      

<script type="text/javascript">


	var timeNow;

	var firstQuakeTime;
	var lastQuakeTime;
	var duration;
	
	const earthRadius = 6731.0;

	var animParams = {
		depthScale: 4.0,
		animLength: 120, // seconds
		finalSceneLength: 30 //seconds
	}
	var animTime;

	
	function Quake(lat,lon,depth,sz,time) {
		this.lat=lat;
		this.lon=lon;
		this.depth=depth;
		this.size=sz;
		this.time=time;
	}
	
	Quake.prototype.getSize = function(time) {
		return this.size/3;
	}

	function mapSize(q,time) {
		var hours = (time - q.date ) / ( 1000*60*60);
		if(time >= lastQuakeTime) {
			hours = 4;
		}
		if (q.size >= 3) {
			return q.size  / Math.min(hours,1);
		}
		return q.size / Math.min(Math.max(0.3,hours),1);
	}	
	
	function mapColor(q,time) {
		var hours = (time - q.date ) / ( 1000*60*60);
		if (q.size >= 3  ) {
			return [0.0, 1.0, 0.0 ,1.0 ];
		}
		if ( hours <= 4.0 ) {
			return [ 1.0, 0.0, 0.0, 1.0]; // "#f00";
		} else if(hours <= 12) {
			return [ 1.0, 0.4, 0.0, 1.0]; //"#f60";
		}
		else if(hours <= 24) {
			return [ 1.0, 1.0, 0.0, 1.0]; // "#ff0";
		}
		else if(hours <= 36) {
			return [ 0.2, 0.4, 0.8, 1.0]; // "#36c";
		}
		else {
			return [ 0.0, 0.0, 0.4, 1.0]; // "#006";
		}

	}


    var rIco = 0;
	var szIco = 0;
	var quakes = [

		 ];
	var timeStart;

    function drawScene(time) {
		document.getElementById("timer").innerHTML=time;
		var mapdepth = document.getElementById("mapdepth").value;
        gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
 
        mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 1000.0, pMatrix);

        mat4.identity(mvMatrix);
		var lap = sphere2Cart(64.701,-17,earthRadius-5);
		var lfp = sphere2Cart(64.7+2*Math.cos((timeNow-timeStart)/5000.0),-17+2*Math.sin((timeNow-timeStart)/5000.0),earthRadius+50);
		mvMatrix = mat4.lookAt([lfp.x,lfp.y,lfp.z]  ,[lap.x,lap.y,lap.z],[lap.x,lap.y,lap.z]);
		/*lap = {x:0,y:0,z:0};
		lfp = {x:1,y:4,z:5};
		mvMatrix = mat4.lookAt([lfp.x,lfp.y,lfp.z]  ,[lap.x,lap.y,lap.z],[0,1,0]);*/
		setLighting();
		for ( i in quakes) {
			
			q=quakes[i];
			if(q.date < time ) {
				drawSphere(q.pos,mapSize(q,time),mapColor(q,time));
			}
		}
		
		drawEarthWF({x:0,y:0,z:0},earthRadius);
		//drawMap(sphere2Cart(64.701,-17,earthRadius),3,4,5);
		drawMap(-animParams.depthScale*mapdepth);
	}

    var lastTime = 0;

    function animate() {
        timeNow = new Date().getTime();
		t1 = ((timeNow - timeStart) % ((animParams.animLength+animParams.finalSceneLength)*1000))/(animParams.animLength*1000);
		if( t1 > 1.0) {
			t1 = 1.0;
		}
		animTime = new Date(firstQuakeTime.getTime() + t1* duration);

        if (lastTime != 0) {
            var elapsed = timeNow - lastTime;

            rIco -= (75 * elapsed) / 1000.0;
			szIco = 1+Math.sin(timeNow/1000.0);

        }
        lastTime = timeNow;
    }


    function tick() {
        requestAnimFrame(tick);
        animate();
		drawScene(animTime);        
    }


    function webGLStart() {
		/*$.getJSON("http://apisis.rasmuskr.dk/earthquake/is",function(resp) {
			quakes = resp.results;
			lastQuakeTime = new Date(quakes[0].timestamp);
			firstQuakeTime = new Date(quakes[quakes.length-1].timestamp);
			duration = lastQuakeTime - firstQuakeTime;
			for ( i in quakes ) {
				quakes[i].date=new Date(quakes[i].timestamp);
				quakes[i].pos=sphere2Cart(quakes[i].latitude, quakes[i].longitude, 6731.0 - 2.0*quakes[i].depth);
			}
		});*/

		$.getJSON("http://isapi.rasmuskr.dk/api/earthquakes/?date=48-hoursago",function(resp) {
			quakes = resp.items;
			//new Date(parseInt(data.date * 1000)).getTime();
			firstQuakeTime = new Date(quakes[0].date * 1000);
			lastQuakeTime = new Date(quakes[quakes.length-1].date*1000);
			duration = lastQuakeTime - firstQuakeTime;
			for ( i in quakes ) {
				quakes[i].date=new Date(quakes[i].date *1000);
				quakes[i].pos=sphere2Cart(quakes[i].lat, quakes[i].long, earthRadius - animParams.depthScale*quakes[i].depth);
			}
		});

        var canvas = document.getElementById("bunga-bunga-canvas");
        initGL(canvas);
        initShaders()
        initIcoSphereBuffer(2);
		initCircleBuffer(360);
		initMapBuffer();
		initTexture();

        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.enable(gl.DEPTH_TEST);
		timeStart = new Date().getTime();
        tick();

    }

</script>


</head>


<body onload="webGLStart();">
<div style="width:100%; overflow:hidden">
	<div id="animation" style="float: left;">
    	<canvas id="bunga-bunga-canvas" style="border: none;" width="800" height="800"></canvas>
		<div id="timer"></div>
    </div>
	<div id="controls" style="margin-left: 820px">Depth of map:<input id="mapdepth" type="range" min="-40" max="2"  width="20px" heigth="100px"/>
	(The map is slightly offset, I'm trying to figure it out)
	<br>
	One day I will try to explain what it is I'm actually trying to show you.
	</div>
</div>
 <div id="credits">
<p class="credit-list">Created by <a href="mailto:blitzkopf@gmail.com">Yngvi Þór</a>, inspired by <a href="http://baering.github.io">3dBulge</a> 
 data provided by <a href="http://www.rasmuskr.dk" target="_blank">RasmusKr</a> and <a href="https://www.vedur.is/"> Veðurstofa Íslands </a>
</div>

   </body>

</html>
